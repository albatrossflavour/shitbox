---
phase: 08-capture-integrity
plan: 02
type: execute
wave: 2
depends_on:
  - "08-01"
files_modified:
  - src/shitbox/capture/ring_buffer.py
  - src/shitbox/events/engine.py
autonomous: true
requirements:
  - CAPT-01
  - CAPT-02
  - CAPT-03

must_haves:
  truths:
    - "After a video save completes, the MP4 is verified to exist with non-zero size"
    - "If verification fails, the driver hears an alert and the callback receives None"
    - "If no timelapse frame is captured within 3x the interval while moving, a warning fires and ffmpeg restarts"
    - "Boot events with fewer than 2 buffer segments skip the video save gracefully"
    - "Empty post-event segments are logged as a warning for diagnostics"
  artifacts:
    - path: "src/shitbox/capture/ring_buffer.py"
      provides: "Post-save verification with alert and post-event empty warning"
      contains: "video_save_verification_failed"
    - path: "src/shitbox/events/engine.py"
      provides: "Boot save guard and timelapse gap watchdog"
      contains: "boot_capture_skipped_no_segments"
  key_links:
    - from: "src/shitbox/capture/ring_buffer.py"
      to: "src/shitbox/capture/buzzer.py"
      via: "beep_capture_failed() call in _do_save_event verification failure"
      pattern: "buzzer\\.beep_capture_failed"
    - from: "src/shitbox/capture/ring_buffer.py"
      to: "src/shitbox/capture/speaker.py"
      via: "speak_capture_failed() call in _do_save_event verification failure"
      pattern: "speaker\\.speak_capture_failed"
    - from: "src/shitbox/events/engine.py"
      to: "src/shitbox/capture/ring_buffer.py"
      via: "_get_buffer_segments() call for boot guard check"
      pattern: "_get_buffer_segments"
---

<objective>
Implement post-save verification, timelapse gap watchdog, and boot save guard to
make all capture integrity tests from Plan 01 pass.

Purpose: These three surgical changes address the field-test failures: (1) silent
video save failures now alert the driver, (2) stuck timelapse extraction is detected
and recovered, and (3) boot events no longer attempt saves with zero segments.

Output: Modified `ring_buffer.py` and `engine.py` with all CAPT requirements
implemented. All 10 tests from Plan 01 pass.
</objective>

<execution_context>
@/Users/tgreen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tgreen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-capture-integrity/08-RESEARCH.md
@.planning/phases/08-capture-integrity/08-01-SUMMARY.md
@src/shitbox/capture/ring_buffer.py
@src/shitbox/events/engine.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add post-save verification and post-event empty warning to ring_buffer.py</name>
  <files>src/shitbox/capture/ring_buffer.py</files>
  <action>
Modify `_do_save_event()` in `ring_buffer.py` to add post-save verification after the
`_concatenate_segments()` call. Replace the existing success/failure block (lines
~641-653) with:

```python
output_path = self._concatenate_segments(all_segments, prefix)
if output_path and output_path.exists() and output_path.stat().st_size > 0:
    log.info(
        "video_save_complete",
        save_id=save_id,
        output=str(output_path),
        size_mb=round(output_path.stat().st_size / (1024 * 1024), 2),
    )
else:
    log.error(
        "video_save_verification_failed",
        save_id=save_id,
        output=str(output_path) if output_path else "None",
        exists=output_path.exists() if output_path else False,
        size=output_path.stat().st_size
        if output_path and output_path.exists()
        else 0,
    )
    try:
        from shitbox.capture import buzzer, speaker
        buzzer.beep_capture_failed()
        speaker.speak_capture_failed()
    except Exception:
        pass  # Alert is best-effort; save callback must still fire
    output_path = None
```

The import-inside-method pattern matches Phase 7 convention (avoids circular imports).
The try/except ensures the alert never prevents the callback from firing.

Also add a post-event empty segments warning after the post-segment copy (line ~630):

```python
if not post_segments:
    log.warning(
        "video_save_post_event_empty",
        save_id=save_id,
        hint="ffmpeg may have been restarting during post-event window",
    )
```

This goes after the `post_segments` variable is assigned and logged, before the
`all_segments` concatenation. It is a diagnostic log only — it does not change the
save flow.

Do NOT add retry logic. The research recommends against it: segments may be stale
by the time of retry. The driver alert is the correct action.
  </action>
  <verify>
    <automated>cd /Users/tgreen/dev/shitbox && pytest tests/test_capture_integrity.py -k "save_verification or post_event_empty or partial_save" -x -v</automated>
    <manual>Read the modified _do_save_event() and confirm the verification block is correct</manual>
  </verify>
  <done>
    _do_save_event() verifies MP4 exists with non-zero size after concatenation.
    Verification failure logs an error, alerts the driver via buzzer and speaker,
    and passes None to the callback. Empty post-event segments log a warning.
    CAPT-01 tests pass. CAPT-03 partial save test passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add boot save guard and timelapse gap watchdog to engine.py</name>
  <files>src/shitbox/events/engine.py</files>
  <action>
**Boot save guard (CAPT-03):**

In `_on_event()`, add a guard before the `save_event()` call for BOOT events. After
the line `if self.video_ring_buffer and self.video_ring_buffer.is_running:` (line ~661)
and before `buzzer.beep_capture_start()`, add:

```python
# Skip boot capture if buffer has no complete segments
if event.event_type == EventType.BOOT:
    segments = self.video_ring_buffer._get_buffer_segments()
    if len(segments) < 2:
        log.info(
            "boot_capture_skipped_no_segments",
            segment_count=len(segments),
        )
        # Still save event metadata without video
        self.event_storage.save_event(event)
        return
```

This goes inside the `if self.video_ring_buffer and self.video_ring_buffer.is_running:`
block. The `< 2` threshold is correct because the newest segment is still being
written — you need at least 2 for one complete segment.

Note: `self.event_storage.save_event(event)` ensures the boot event metadata is still
recorded in the database even when video is skipped.

**Timelapse gap watchdog (CAPT-02):**

In `_check_timelapse()`, add a gap detection block AFTER the interval check (line ~1394)
and BEFORE the speed check. Add a constant at class level:

```python
TIMELAPSE_GAP_FACTOR = 3  # alert if 3x interval passes with no capture
```

Then in `_check_timelapse()`, after the `has_capture_source` check and before the
existing interval check, add:

```python
# Gap watchdog: detect stuck timelapse extraction
elapsed = now - self._last_timelapse_time
gap_threshold = self.config.timelapse_interval_seconds * self.TIMELAPSE_GAP_FACTOR
if (
    elapsed > gap_threshold
    and self._last_timelapse_time > 0.0
    and self._current_speed_kmh >= self.config.timelapse_min_speed_kmh
):
    log.warning(
        "timelapse_gap_detected",
        elapsed_seconds=round(elapsed),
        expected_interval=self.config.timelapse_interval_seconds,
    )
    # Attempt recovery: restart ffmpeg
    if self.video_ring_buffer and self.video_ring_buffer.is_running:
        self.video_ring_buffer._kill_current()
        self.video_ring_buffer._start_ffmpeg()
    self._last_timelapse_time = now  # Reset to avoid repeat alerts
    return  # Skip normal capture this iteration
```

The `_last_timelapse_time > 0.0` guard prevents false alarms at boot (Pitfall 3 from
research). The `return` after recovery skips the normal capture attempt this iteration
so the restarted ffmpeg has time to produce a segment.
  </action>
  <verify>
    <automated>cd /Users/tgreen/dev/shitbox && pytest tests/test_capture_integrity.py -x -v</automated>
    <manual>Read the modified _on_event() and _check_timelapse() to confirm guards are correct</manual>
  </verify>
  <done>
    All 10 capture integrity tests pass. Boot events with zero segments are skipped
    with a log message. Timelapse gaps are detected after 3x the interval and trigger
    ffmpeg recovery. No false positives at boot (sentinel guard).
  </done>
</task>

<task type="auto">
  <name>Task 3: Full test suite and lint validation</name>
  <files>
    src/shitbox/capture/ring_buffer.py
    src/shitbox/events/engine.py
    tests/test_capture_integrity.py
  </files>
  <action>
Run the full test suite to confirm no regressions. Run ruff check on all modified
files. Run mypy on the modified source files.

Fix any lint or type errors introduced by the changes. Common issues to watch for:
- `output_path` may be `Optional[Path]` — ensure `.exists()` and `.stat()` calls
  are guarded by the truthiness check
- `_get_buffer_segments` returns `list[Path]` — `len()` is always safe
- The `from shitbox.capture import buzzer, speaker` inside `_do_save_event` must
  be inside try/except to avoid `ImportError` on non-Pi hosts

If any existing tests fail, investigate whether the failure is caused by this phase's
changes. Pre-existing failures (e.g. mypy errors in sampler.py) are out of scope.
  </action>
  <verify>
    <automated>cd /Users/tgreen/dev/shitbox && pytest tests/test_capture_integrity.py tests/test_ffmpeg_stall.py -x -v && ruff check src/shitbox/capture/ring_buffer.py src/shitbox/events/engine.py</automated>
    <manual>Confirm no regressions in existing stall detection tests</manual>
  </verify>
  <done>
    All capture integrity tests pass. All existing ffmpeg stall tests pass.
    ruff check passes on all modified files. No regressions introduced.
  </done>
</task>

</tasks>

<verification>
- `pytest tests/test_capture_integrity.py -x -v` — all 10 tests pass
- `pytest tests/test_ffmpeg_stall.py -x -v` — no regressions
- `ruff check src/shitbox/capture/ring_buffer.py src/shitbox/events/engine.py` — clean
- `grep "video_save_verification_failed" src/shitbox/capture/ring_buffer.py` — verification log exists
- `grep "boot_capture_skipped_no_segments" src/shitbox/events/engine.py` — boot guard exists
- `grep "timelapse_gap_detected" src/shitbox/events/engine.py` — gap watchdog exists
</verification>

<success_criteria>
- CAPT-01: Post-save verification detects missing/empty MP4 and alerts the driver
- CAPT-02: Timelapse gap watchdog fires after 3x interval, recovers via ffmpeg restart
- CAPT-03: Boot events with zero segments are skipped; partial saves (pre-only) are preserved
- All 10 tests from Plan 01 pass
- No regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/08-capture-integrity/08-02-SUMMARY.md`
</output>
